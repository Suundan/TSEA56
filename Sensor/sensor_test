/*
 * sensor_test.c
 *
 * Created: 2016-04-06 14:46:59
 * Author : Milton
 */ 
#define F_CPU 1000000UL
#include <avr/io.h>
#include <avr/delay.h>
#include <stdio.h>
unsigned int measure_count = 0x00;
unsigned int distance = 0x00;
unsigned int us_converter = 0x3a;


void set_values()
{
DDRA = 0b00000010; // Sätter PA1 till utgång
DDRB = 0b11111111; // Sätter alla b-portar till utgångar för att kunna testa längdräkning

}

void measure()
{
	PORTA |= (1<<PORTA1); // Sätter PA1 till hög under bestämd tid
	_delay_us(100);
	PORTA &= ~(1<<PORTA1);// Sätter PA1 till låg och startar mätningen
	if(PORTA2 == 1)  // Sålänge Echo_out är 1 så räknas measure_count upp med 1us per klockpuls
	{
	measure_count = 0x00;
	distance = 0x00;
	count();
	}

	distance = measure_count/us_converter;	//sparar undan avståndet som är antal us delat med 58
	PORTB |= distance;
	_delay_ms(10);
}

void count()
{
	if(PORTA1 == 1)
	{
	++measure_count;
	count();
	}

}



int main(void)
{
	
    set_values();
	
    while (1) 
    {
		
		measure();
		/*
		if(PORTA2 == 1)  // Sålänge Echo_out är 1 så räknas measure_count upp med 1us per klockpuls
		{
			measure_count = 0x00;
			distance = 0x00;
			count();
		}
		
		distance = measure_count/us_converter;	//sparar undan avståndet som är antal us delat med 58
		PORTB |= distance;
		_delay_ms(10);
		*/
	}
return 0;
}
